{% extends "src/Bowling/Resources/views/layout.html.twig" %}

{% set menu = 'Journées' %}
{% set titre = 'journée' %}
{% set route = 'bowling-journee' %}

{% block breadcrumb %}
    {{ parent() }}
    <li>{{ menu }}</li>
    <li>Consultation</li>
    {% endblock %}

{% block content %}
    <h3>Consultation des {{ nbRecords }} {{ titre }}{{ nbRecords > 1 ? 's' : ''}}
        <small>
            {% include 'app/Resources/views/fragments/ajoutRecord.html.twig' with {'genre': 'f', 'titre': titre, } %}
        </small>
    </h3>

    <div class="table-responsive">
        <table class="table table-bordered table-hover compact">
            <thead>
                <tr>
                    <th colspan="4">Journée</th>
                    <th colspan="2">Série</th>
                    <th colspan="9">Parties</th>
                </tr>
                <tr>
                    <th>Maj</th>
                    <th>Evènement</th>
                    <th>Hand.</th>
                    <th>Moy.</th>
                    <th>Série</th>
                    <th>Moy.</th>
                    <th>Score</th>
                    <th>X</th>
                    <th>/</th>
                    <th>Splits</th>
                    <th>Gagnée</th>
                    <th>Ex.My</th>
                    <th>Carnet</th>
                    <th>7/10</th>
                    <th>Supp.</th>
                </tr>
            </thead>
            <tr>
                {# pour chaque journée#}
                {% for jnee in records %}
                    <td class="text-center w1"
                        rowspan="{{ jnee.nbScores }}"
                        id="idJnee{{ jnee.id }}"
                        >
                        <a href="{{ path(route ~ '-update', {'id' : jnee.id} ) }}"
                           title="Modifier la journée"
                           alt="Modifier la journée" >
                            <span class="glyphicon glyphicon-pencil">&nbsp;</span>
                        </a>
                        <br /><br />
                        <a href="#" 
                           class            =   "supprimer-journee"
                           id               =   "supprimer-journee-{{ jnee.id }}"
                           aria-hidden      =   "true"
                           data-target      =   "#myModal"
                           data-toggle      =   "modal"
                           role             =   "tooltip"
                           data-placement   =   "top"
                           data-journee     =   "{{ jnee.id }}"
                           title            =   "Suppression de la journée"
                           alt              =   "Suppression de la journée"
                           >
                            <span class="glyphicon glyphicon-trash">&nbsp;</span>
                        </a>
                    </td>
                    <td class="text-left"
                        rowspan="{{ jnee.nbScores }}">
                        <b>{{ jnee.dateJournee|strftime('%a %d/%m/%Y') }}</b><br />
                        {#                                                Jid = {{ jnee.id }}<br />#}
                        {{ jnee.evenement.typeJeu.libelle is null ? '--' : jnee.evenement.typeJeu.libelle }}, 
                        {{ jnee.evenement.libelle is null ? '--' : jnee.evenement.libelle }},<br />
                        <b>{{ jnee.bowling is null ? '--' : jnee.bowling.nom }}</b>
                        {% if jnee.tournoi is not null %}
                            ({{ jnee.tournoi.commentaire }})
                        {% endif %}
                    </td>
                    <td class="text-center w2"
                        rowspan="{{ jnee.nbScores }}">
                        {{ jnee.handicap }}
                    </td>
                    <td class="text-center w1"
                        rowspan="{{ jnee.nbScores }}">
                        {{ jnee.moyenne|number_format(2, ',', ' ') }}
                    </td>
                    {# pour chaque série #}
                    {% for serie in jnee.series %}
                        <td class="text-center separ-gauche"
                            rowspan="{{ serie.nbScores }}"
                            id="idSerie{{ serie.id }}"
                            >
                            {{ serie.dateSerie|strftime('%a %d/%m') }}<br />
                            {#<small>id : {{ serie.id }}</small><br />#}
                            N° : {{ serie.noSerie }}
                        </td>
                        <td class="text-right"
                            rowspan="{{ serie.nbScores }}">
                            {{ serie.moyenne|number_format(2, ',', ' ') }}
                        </td>
                        {# pour chaque score #}
                        {% for score in serie.scores %}
                            {#                            <td class="text-center separ-gauche"><small>{{ (score.id) }}</small></td>#}
                            <td class="text-center w1 separ-gauche"><b>{{ (score.score) }}</b></td>
                            <td class="text-center w1">{{ (score.strike) }}</td>
                            <td class="text-center w1">{{ (score.spare) }}</td>
                            <td class="text-center w1">{{ (score.split) }}</td>
                            <td class="text-center">
                                {% if score.gagnee == TRUE %}
                                    <span class="glyphicon glyphicon-ok"></span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if score.pasCalculMoyenne == TRUE %}
                                    <span class="glyphicon glyphicon-ok"></span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if score.surCarnetEntrainement == TRUE %}
                                    <span class="glyphicon glyphicon-ok"></span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if score.septDix == TRUE %}
                                    <span class="glyphicon glyphicon-ok"></span>
                                {% endif %}
                            </td>
                            <td class="text-center w1">
                                <a href="{{ path('bowling-score-delete', {'id' : score.id} ) }}"
                                   title="Supprimer la partie">
                                    <span class="glyphicon glyphicon-trash"></span>
                                </a>
                            </td>
                        </tr>
                        <tr>
                        {% else %}
                        <tr>
                            <td class="text-center"
                                colspan="3">
                                Pas de score
                            </td>
                        </tr>
                    {% endfor %}
                    {# Fin score #}
                {% endfor %}
                {# Fin série #}
                </tr>
            {% else %}
                <tr>
                    <td class="text-center"
                        colspan="33">
                        <b>Pas de journée sur cette saison</b>
                    </td>
                </tr>
            {% endfor %}
            {# Fin journée #}
            </tbody>
        </table>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    ATTENTION
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Doit-on vraiment supprimer cette journée<br />
                    ainsi que tous ses scores associés ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="btn-delete-journee">Oui</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Non</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}    
    {{parent()}}

    <script type="text/javascript">
        $(document).ready(function () {

            var idJournee = 0;

            $('#myModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);            // Button that triggered the modal

        console.log(button);

                idJournee = button.attr('data-journee');
            });

            $(document).on('click', '#btn-delete-journee', function () {
                $.ajax({
                    dataType: "json",
                    method: "post",
                    cache: false,
                    url: "{{ path(route ~ '-delete') }}",
                    data: {
                        'id': idJournee,
                    },
                    success: function (data) {
                        $('#myModal').modal('hide');
                        location.reload();
                        return false;
                    }
                });
                return false;
            });

            // ajout de la classe souligné sur le tr parent d'un id de journée
            $('[id^="idJnee"]').parent("tr").addClass("next");

            // ajout de la classe souligné sur le tr parent d'un id de série
            $('[id^="idSerie"]').parent("tr").addClass("next");

        });

    </script>
{% endblock %}
